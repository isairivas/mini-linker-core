<?php
class Model_Cliente extends Lib_Mvc_Model {
	public function __construct(){
		parent::__construct('clientes', 'id');
	}
	
	/* Guarda los datos del cliente */
	public function save($cliente){
		
		try{
		
			/* verificar si existe el email registrado */
			$clienteTemp = $this->getByEmail($cliente['email']);
			/* si no existe el cliente insertarlo */
			if(!$clienteTemp){
				 $inserto = $this->insert($cliente);
				if(!$inserto){
					throw new Exception('No se pudo insertar el cliente');
				}
				$nuevoCliente = $this->getByEmail($cliente['email']);
				return $nuevoCliente['id'];
			} else{
				$this->update($cliente," WHERE id = {$clienteTemp['id']} ");
				return $clienteTemp['id'];
			}
		}catch(Exception $e){
			throw new Exception($e->getMessage());
		}
	}
	
	public function getByEmail($email){
		$result = $this->toArray($this->select(" WHERE email = '{$email}' "));
		if(count($result) > 0 ){
			return $result[0];
		} else {
			return false;
		}
	}
	
	public function getAllClientes(){
		$query = " SELECT  "
				."        cli.*, "
				."       DATE_FORMAT(cli.created_at,'%X/%m/%d  %H:%i') AS fecha "
				.'  FROM clientes cli '
				."       "
				.'';
		
		$db = $this->getDB();
		$result = $this->toArray($db->query($query));
		return $result;
	}
	
}

