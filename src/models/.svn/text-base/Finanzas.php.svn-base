<?php
class Model_Finanzas {
	
	public function __construct(){
		$this->initConfigurationAdmin();
	}
	
	public function cotizar($ingresoMensual,$egresoMensual,$numeroDePeriodos){
		
		/*  datos de configuracion del admin */
		$porcentajeDeIva = APP_PORCENTAJE_DE_IVA;
		$porcentajeDeTasaAnual = APP_PORCENTAJE_DE_TASA_ANUAL;
		$porcentajeDeComisionDeApertura = APP_PORCENTAJE_DE_COMISION_DE_APERTURA;
		$porcentajeDeSeguro = APP_PORCENTAJE_DE_SEGURO;
		$porcentajeDeTasaMensual = APP_PORCENTAJE_DE_TASA_MENSUAL;
		
		/* calculo de la inversion y datos derivados */
		$ingresoLibre 		  = $ingresoMensual - $egresoMensual;
		$pagoMensualRecomendado = ($ingresoLibre/3);
		$valorActual = $this->getValorActual( $numeroDePeriodos, $pagoMensualRecomendado, $porcentajeDeTasaMensual, $porcentajeDeIva );
		$comisionDeApertura = $valorActual * ($porcentajeDeComisionDeApertura/100);
		$seguro = $valorActual * ($porcentajeDeSeguro/100);
		$montoAFinanciar = ($valorActual + $comisionDeApertura + $seguro);
		$pagoPorPeriodo = $this->getPagoPorPeriodo($numeroDePeriodos, $montoAFinanciar, $porcentajeDeTasaMensual, $porcentajeDeIva );
		
		
		/* guardar la informacion del resultado */
		$resultado = array(
			'ingresoMensual'         => $ingresoMensual,
			'egresoMensual'          => $egresoMensual,
			'numeroDePeriodos'       => $numeroDePeriodos,
			'ingresoLibre'           => $ingresoLibre,
			'pagoMensualRecomendado' => $pagoMensualRecomendado,
			'valorActual'             =>   $valorActual,
			'comisionDeApertura' => $comisionDeApertura,
			'seguro'             => $seguro,
			'suma'               => ($valorActual + $comisionDeApertura + $seguro),
			'porcentajeDeTasaMensual' => $porcentajeDeTasaMensual,
			'montoAFinanciar'         => $montoAFinanciar,
			'pagoPorPeriodo'          => $pagoPorPeriodo
		);
		;
		
		/* obtener el numero de pagos y sus detalles de cada pago */
		$pagos = array();
		for($periodo = 1;$periodo <= $numeroDePeriodos; $periodo++){
			$intereses = $montoAFinanciar * ($porcentajeDeTasaMensual/100);
			$ivaIntereses = $intereses * ($porcentajeDeIva/100);
			$pagoACapital = $pagoPorPeriodo - $intereses - $ivaIntereses;
			$montoAFinanciar = $montoAFinanciar - $pagoACapital;
			$pagos[] = array(
						'periodo' => $periodo,
						'intereses' => $intereses,
						'ivaIntereses' => $ivaIntereses,
						'pagoACapital' => $pagoACapital,
						'montoAFinanciar' => $montoAFinanciar
					);
			
		}
		
		$resultado['pagos'] = $pagos;
		
		return $resultado;
	}
	
	private function getValorActual($periodos,$pagoPorPeriodo, $porcentajeTasaPorPeriodo,$porcentajeIva){
		$factorIva = (1 + ($porcentajeIva / 100));
		
		if(SHOW_DETAILS){
			echo ( "Factor IVA: " . $factorIva .'<br/>' );
		}
		$tasaPorPeriodo = ($porcentajeTasaPorPeriodo / 100) * $factorIva;
		
		if(SHOW_DETAILS){
			echo( "Tasa por periodo: " . $tasaPorPeriodo . '<br/>' );
		}
		$valorActual = ($pagoPorPeriodo * (1 - pow( (1 + $tasaPorPeriodo), -($periodos) ))) / $tasaPorPeriodo;
		
		if(SHOW_DETAILS){
			echo( "Valor actual: " . $valorActual .'<br/>' );
		}
		return $valorActual;
	}
	
	private function getPagoPorPeriodo( $periodos,$valorActual, $porcentajeTasaPorPeriodo, $porcentajeIva ) {
		$factorIva = (1 + ($porcentajeIva / 100));
		
		if(SHOW_DETAILS){
			echo( "Factor IVA: " . $factorIva .'<br/>' );
		}
		$tasaPorPeriodo = ($porcentajeTasaPorPeriodo / 100) * $factorIva;
		
		if(SHOW_DETAILS){
			echo ( "Tasa por periodo: " . $tasaPorPeriodo .'<br/>' );
		}
		$pagoPorPeriodo = $valorActual / (((1 - pow( (1 + $tasaPorPeriodo), -($periodos) ))) / $tasaPorPeriodo);
	
		return $pagoPorPeriodo;
	}
	
	private function initConfigurationAdmin(){
		
		$porcentajeDeIva = 16;
		$porcentajeDeTasaAnual = 34;
		$porcentajeDeComisionDeApertura = 6;
		$porcentajeDeSeguro = 1;
		$porcentajeDeTasaMensual = ($porcentajeDeTasaAnual/12); 
		
		define('APP_PORCENTAJE_DE_IVA',$porcentajeDeIva);
		define('APP_PORCENTAJE_DE_TASA_ANUAL',$porcentajeDeTasaAnual);
		define('APP_PORCENTAJE_DE_COMISION_DE_APERTURA',$porcentajeDeComisionDeApertura);
		define('APP_PORCENTAJE_DE_SEGURO',$porcentajeDeSeguro);
		define('APP_PORCENTAJE_DE_TASA_MENSUAL',$porcentajeDeTasaMensual);
	}
}

